// prisma/schema.prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

/**
 * =========================
 * Enums
 * =========================
 */

enum UserRole {
  CUSTOMER
  VENDOR
  STAFF
  ADMIN
}

enum VendorStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

enum ProductStatus {
  DRAFT
  PENDING_REVIEW
  PUBLISHED
  ARCHIVED
}

enum ProductType {
  DIGITAL_DOWNLOAD
  LIVE_CLASS
  BUNDLE
  PHYSICAL
}

enum OrderStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentProvider {
  STRIPE
  PAYPAL
}

enum QuestionStatus {
  PENDING
  ANSWERED
  HIDDEN
}

enum ReviewStatus {
  PENDING
  PUBLISHED
  REJECTED
}

enum CommissionStatus {
  PENDING
  READY
  PAID
  ADJUSTED
}

enum PayoutStatus {
  INITIATED
  COMPLETED
  FAILED
}

/**
 * =========================
 * Core user / vendor
 * =========================
 */

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String? // optional if you use external auth and just mirror users
  firstName String?
  lastName  String?
  role      UserRole @default(CUSTOMER)

  profile   UserProfile?
  vendor    Vendor?
  questions ProductQuestion[]
  reviews   ProductReview[]
  orders    Order[]

  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @default(now()) @updatedAt
  vendorApplications VendorApplication[]
}

model UserProfile {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id])
  userId String @unique

  phone           String?
  timezone        String?
  // You can break these into separate address tables if needed
  billingAddress  String?
  shippingAddress String?

  newsletterOptIn Boolean @default(false)
}

model Vendor {
  id String @id @default(cuid())

  // Make user optional for now so you don't need auth wired yet
  user   User?   @relation(fields: [userId], references: [id])
  userId String? @unique

  name         String
  slug         String       @unique
  logoUrl      String?
  heroImageUrl String?
  description  String?
  location     String?
  contactEmail String?
  contactPhone String?
  status       VendorStatus @default(PENDING)

  stripeConnectId   String? // Stripe account ID
  defaultCommission Float? // e.g. 0.7 = 70% to vendor

  products          Product[]
  questionsAnswered ProductQuestion[] @relation("VendorAnsweredQuestions")
  commissions       Commission[]
  payouts           Payout[]

  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  orderItems OrderItem[]
}

/**
 * =========================
 * Taxonomy: Categories & Tags
 * =========================
 */

model Category {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?
  parent      Category?  @relation("CategoryChildren", fields: [parentId], references: [id])
  parentId    String?
  children    Category[] @relation("CategoryChildren")

  products ProductCategory[]

  sortOrder Int?
}

model Tag {
  id   String @id @default(cuid())
  name String
  slug String @unique

  products ProductTag[]
}

/**
 * =========================
 * Product + joins
 * =========================
 */

model Product {
  id       String @id @default(cuid())
  vendor   Vendor @relation(fields: [vendorId], references: [id])
  vendorId String

  title            String
  slug             String  @unique
  subtitle         String?
  shortDescription String?
  longDescription  String?

  // keep naming compatible with your existing code
  priceCents     Int // store in cents
  salePriceCents Int?

  status ProductStatus @default(DRAFT)
  type   ProductType   @default(DIGITAL_DOWNLOAD)

  sku          String?
  thumbnailUrl String?
  featured     Boolean @default(false)

  ageMin Int?
  ageMax Int?

  categories ProductCategory[]
  tags       ProductTag[]
  files      ProductFile[]
  orderItems OrderItem[]
  questions  ProductQuestion[]
  reviews    ProductReview[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProductCategory {
  product    Product  @relation(fields: [productId], references: [id])
  productId  String
  category   Category @relation(fields: [categoryId], references: [id])
  categoryId String

  @@id([productId, categoryId])
}

model ProductTag {
  product   Product @relation(fields: [productId], references: [id])
  productId String
  tag       Tag     @relation(fields: [tagId], references: [id])
  tagId     String

  @@id([productId, tagId])
}

model ProductFile {
  id        String  @id @default(cuid())
  product   Product @relation(fields: [productId], references: [id])
  productId String

  title            String
  fileUrl          String // Supabase storage / S3 URL
  downloadLimit    Int?
  expiresAfterDays Int?
}

/**
 * =========================
 * Orders / Checkout
 * =========================
 */

model Order {
  id     String  @id @default(cuid())
  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  status          OrderStatus      @default(PENDING)
  totalAmount     Int // cents
  currency        String           @default("usd")
  paymentProvider PaymentProvider?
  providerOrderId String? // Stripe payment intent / PayPal ID

  billingEmail String?
  billingName  String?

  items     OrderItem[]
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

model OrderItem {
  id      String @id @default(cuid())
  order   Order  @relation(fields: [orderId], references: [id])
  orderId String

  product   Product @relation(fields: [productId], references: [id])
  productId String

  vendor   Vendor @relation(fields: [vendorId], references: [id])
  vendorId String

  quantity  Int @default(1)
  unitPrice Int // cents at time of purchase
  subtotal  Int // quantity * unitPrice

  commissionRateSnapshot Float // e.g. 0.7 for 70% to vendor
  vendorEarnings         Int // cents
  platformFee            Int // cents

  commission Commission?
}

/**
 * =========================
 * Commissions / Payouts
 * =========================
 */

model Commission {
  id          String    @id @default(cuid())
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id])
  orderItemId String    @unique // ðŸ‘ˆ add this

  vendor   Vendor @relation(fields: [vendorId], references: [id])
  vendorId String

  amountVendor   Int
  amountPlatform Int
  status         CommissionStatus @default(PENDING)

  payout   Payout? @relation(fields: [payoutId], references: [id])
  payoutId String?

  createdAt DateTime @default(now())
}

model Payout {
  id       String @id @default(cuid())
  vendor   Vendor @relation(fields: [vendorId], references: [id])
  vendorId String

  totalAmount      Int // cents
  currency         String       @default("usd")
  status           PayoutStatus @default(INITIATED)
  stripeTransferId String?

  commissions Commission[]

  createdAt   DateTime  @default(now())
  completedAt DateTime?
}

/**
 * =========================
 * Questions & Reviews
 * =========================
 */

model ProductQuestion {
  id        String  @id @default(cuid())
  product   Product @relation(fields: [productId], references: [id])
  productId String

  customer   User   @relation(fields: [customerId], references: [id])
  customerId String

  questionText String

  answerText         String?
  answeredByVendor   Vendor? @relation("VendorAnsweredQuestions", fields: [answeredByVendorId], references: [id])
  answeredByVendorId String?

  status QuestionStatus @default(PENDING)

  createdAt  DateTime  @default(now())
  answeredAt DateTime?
}

model ProductReview {
  id        String  @id @default(cuid())
  product   Product @relation(fields: [productId], references: [id])
  productId String

  customer   User   @relation(fields: [customerId], references: [id])
  customerId String

  rating Int // 1â€“5
  title  String?
  body   String
  status ReviewStatus @default(PENDING)

  createdAt   DateTime  @default(now())
  publishedAt DateTime?
}

/**
 * =========================
 * Vendor applications
 * =========================
 */

model VendorApplication {
  id     String  @id @default(cuid())
  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  name         String
  email        String
  phone        String?
  businessName String?
  website      String?
  bio          String?
  whatTheySell String?

  status     String  @default("SUBMITTED") // could become an enum later
  adminNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
